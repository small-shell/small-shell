<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Cook Book - small-shell.org</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/docco.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">small-shell.org</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Quick Start <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../quick_start_linux/" class="dropdown-item">For Ubuntu or debian</a>
</li>
                                    
<li>
    <a href="../quick_start_linux_apache2/" class="dropdown-item">For Ubuntu + apache2 </a>
</li>
                                    
<li>
    <a href="../quick_start_Mac/" class="dropdown-item">For macOS</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Shell tour <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../app_shell_tour/" class="dropdown-item">APP Shell</a>
</li>
                                    
<li>
    <a href="../data_shell_tour/" class="dropdown-item">DATA Shell</a>
</li>
                                    
<li>
    <a href="../app_shell_form/" class="dropdown-item">Create Form</a>
</li>
                                    
<li>
    <a href="../app_shell_scratch/" class="dropdown-item">Create Scratch APP</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Cook Book</a>
</li>
                                    
<li>
    <a href="../automation_tour/" class="dropdown-item">E-cron (Automate & dataExchange)</a>
</li>
                                    
<li>
    <a href="../python_tour/" class="dropdown-item">Pyshell</a>
</li>
                                    
<li>
    <a href="../auth_shell/" class="dropdown-item">Auth</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item">
                                <a rel="prev" href="../app_shell_scratch/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../automation_tour/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#cook-book" class="nav-link">Cook book</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#cook-prototype-app" class="nav-link">Cook prototype APP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#set-notification-mail-to-form" class="nav-link">Set notification mail to Form</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#portal-design-recipe" class="nav-link">Portal design recipe</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#deploy-auto-ssl-cetificate" class="nav-link">Deploy auto SSL cetificate</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#backup-restore-example" class="nav-link">Backup &amp; Restore example</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#log-analyzer" class="nav-link">Log analyzer</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="cook-book">Cook book</h1>
<p>In this course, we would like to show how you can utilize APPs { Base APP, Scratch APP, Form } and we would like to also share the recipe of design change of HTML/CSS descriptor.</p>
<h2 id="cook-prototype-app">Cook prototype APP</h2>
<p>In this protoype scinario we would like to cook library booking APP. Base APP will be used for data management of admin, Scrath APP will be used for data search for end user and Form will be used for request form. </p>
<h5 id="app">APP</h5>
<pre><code>APP for admin = Base APP
APP for user  = book_search, req.form
</code></pre>
<h5 id="databox">Databox</h5>
<p>Databoxes are created as following. book.master will be master data of book information, book.res is resource information including location information each resource, and request.db is databox for request from end user.</p>
<pre><code>book.master  &lt;-- book.res #res=resource &lt;-- request.db
</code></pre>
<p>Let's start to generate databox</p>
<h3 id="create-databox">Create databox</h3>
<pre><code>sudo -u small-shell /usr/local/small-shell/gen -databox

1. book.master { name: text, isbn: num, author: text, category: select, desciption: textarea, available: checkbox}
2. book.res  { hashid, name: pdls(book.master), location: select, status: select }
3. request.db  { hashid, requester: text, email: email, book_name: text, status: select, book_resource: pdls(book.res), message: textarea }
</code></pre>
<p>Please check the sample definition <a href="https://github.com/21it-org/21it/tree/main/templates/cookbook/def">db.def</a></p>
<h3 id="launch-base-app">Launch Base APP</h3>
<p>Let's launch Base APP by refering to <a href="../quick_start_linux/">Quick start</a></p>
<pre><code>sudo /usr/local/small-shell/adm/gen -app
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 1  
#-&gt; Dialog will be started, for making Base APP
</code></pre>
<h4 id="add-data-by-using-base-app">Add data by using Base APP</h4>
<p>For managing datas, let's use Base APP.</p>
<pre><code>STEP1 Add master data to book.master
STEP2 Add resource data to bookk.res that will be linked to master data
</code></pre>
<h3 id="create-scratch-app">Create scratch APP</h3>
<p>Once databoxes and Base APP is created, let's create APPs</p>
<h4 id="create-main-app">Create Main APP</h4>
<p>Let's execute gen -app to create book_search APP, then access URL will be shown.</p>
<pre><code>sudo /usr/local/small-shell/adm/gen -app 
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 3
app_name: book_search
Type of Authentication (1.shared pass | 2.user key | 3.other | 4.none): 4
primary databox: book.master
</code></pre>
<h4 id="add-sub-app">Add sub APP</h4>
<p>Once main APP is created, let's add table to the APP using sub APP. this sub APP is used for searching book resource and location.</p>
<pre><code>sudo /usr/local/small-shell/adm/gen -app 
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 3
app_name: location@book_search
Type of Authentication (1.shared pass | 2.user key | 3.Other | 4.None): 4
primary databox: book.res
</code></pre>
<h3 id="generate-meta-link">Generate meta link</h3>
<p>meta links can be generated for each APPs. and let's cook it as next step.</p>
<pre><code># generate link
sudo -u small-shell /usr/local/small-shell/bin/meta get.link:book_search
sudo -u small-shell /usr/local/small-shell/bin/meta get.link:location@book_search
</code></pre>
<h3 id="cook-app">Cook APP</h3>
<h4 id="update-portal">update portal</h4>
<p>Portal page can be editted by both markdown grammer and legacy HTML tag, lets write down description of this application. detail is in 
<a href="./#portal-design-recipe">Cook main page</a> section. you can also update menu of portal on Base APP.</p>
<p><img alt="Screenshot" src="../img/book_search_portal.png" /></p>
<h4 id="add-logics-to-the-app">Add logics to the APP</h4>
<p>In this example, we are adding following functions to book_search APP</p>
<ol>
<li>Add link from master data to resource table</li>
<li>Filter table to show only available data</li>
<li>Restrict key</li>
<li>Add link from resource data to master data</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you insert sed or awk in codes, it's recommended to used $SED and $AWK value. the parameter is defined at /usr/local/small-shlel/global.conf</p>
</div>
<h5 id="add-link-from-master-data-to-resource-table">Add link from master data to resource table</h5>
<pre><code>sudo vi /var/www/descriptor/book_search_get_ro.html.def
--code--
&lt;div class=&quot;action_links&quot;&gt;
&lt;span&gt;&lt;a href=&quot;./book_search?%%session&amp;subapp=location&amp;req=table&amp;table_command=%%book_name&quot;&gt;&lt;p&gt;location table&lt;/p&gt;&lt;/a&gt;&lt;/span&gt;
&lt;/div&gt;
--------
</code></pre>
<p>To insert %%book_name, let's add these logics to get action.</p>
<pre><code>sudo vi /var/www/bin/book_search_get.sh
# block1 { get ID book_namd }
--code--
book_name=`$DATA_SHELL databox:book.res action:get key:name id:$id format:none | $AWK -F &quot;:&quot; '{print $2}'`
--------
# block2 { update $SED logic to insert book_name }
--code--
cat ../descriptor/${view} | $SED &quot;s/^ *&lt;/&lt;/g&quot; \
| $SED &quot;/%%common_menu/r ../descriptor/common_parts/book_adm_common_menu&quot; \
| $SED &quot;/%%common_menu/d&quot; \
| $SED &quot;/%%dataset/r ../tmp/$session/dataset&quot; \
| $SED &quot;s/%%dataset//g&quot;\
| $SED &quot;/%%history/r ../tmp/$session/history&quot; \
| $SED &quot;s/%%history//g&quot;\
| $SED &quot;s/%%id/$id/g&quot; \
| $SED &quot;s/%%book_name/$book_name/g&quot; \
| $SED &quot;s/%%pdls/session=$session\&amp;pin=$pin\&amp;req=get/g&quot; \
| $SED &quot;s/%%session/session=$session\&amp;pin=$pin/g&quot; \
| $SED &quot;s/%%params/session=$session\&amp;pin=$pin/g&quot;
--------
</code></pre>
<p><img alt="Screenshot" src="../img/book_search_location_link.png" /></p>
<h5 id="filter-table-to-show-only-available-data">Filter table to show only available data</h5>
<p>To filter the master table only available data, let's add match option.</p>
<pre><code>sudo vi /var/www/bin/book_search_table.sh
# e.g.) $DATA_SHELL databox:$databox command:show_all[line=$line_start-$line_end][keys=$keys][filter=${filter_table}][match=available{yes}]
</code></pre>
<p>To filter the location table only on the shelve, let's add match option. by the way {%%%%%%%} is meta charactor of small-shell. it will be translated to _, I mean on{%%%%%%%}the{%%%%%%%}shelve} will be translated to on_the_shelve.</p>
<pre><code>sudo vi /var/www/bin/location_table.sh
# e.g. ) $DATA_SHELL databox:$databox command:show_all[line=$line_start-$line_end][keys=$keys][filter=${filter_table}][match=status{on{%%%%%%%}the{%%%%%%%}shelve}]

</code></pre>
<h5 id="restrict-key">Restrict key</h5>
<p>To restrict accessable key, please change all to specific keys.</p>
<pre><code>sudo vi /var/www/bin/location_get.sh
# -&gt; change keys from all to specific keys.
keys=hashid,name,location
</code></pre>
<pre><code>sudo vi /var/www/bin/location_table.sh
# -&gt; change keys from all to specific keys.
keys=hashid,name,location
</code></pre>
<h5 id="add-link-from-resource-data-to-master-data">Add link from resource data to master data</h5>
<pre><code>sudo vi /var/www/descriptor/location_get_ro.html.def
--code--
&lt;div class=&quot;action_links&quot;&gt;
&lt;span&gt;&lt;a href=&quot;./book_search?%%session&amp;req=get&amp;id=%%book_id&quot;&gt;&lt;p&gt;Master data&lt;/p&gt;&lt;/a&gt;&lt;/span&gt;
&lt;/div&gt;
--------
</code></pre>
<p>To insert %%book_id, let's modify render logics to get action.</p>
<pre><code>sudo vi /var/www/bin/location_get.sh
--code--
# render HTML
resource_id=$id
book_name=`$DATA_SHELL databox:book.res action:get key:name id:$id format:none | $AWK -F &quot;:&quot; '{print $2}'`
book_id=`$DATA_SHELL databox:book.master command:show_all[match=name{$book_name}] format:json | jq '.[] | .id'| $SED -s &quot;s/\&quot;//g&quot;`

cat ../descriptor/${view} | $SED &quot;s/^ *&lt;/&lt;/g&quot; \
| $SED &quot;/%%common_menu/r ../descriptor/common_parts/book_search_common_menu&quot; \
| $SED &quot;/%%common_menu/d&quot; \
| $SED &quot;/%%dataset/r ../tmp/$session/dataset&quot; \
| $SED &quot;s/%%dataset//g&quot;\
| $SED &quot;/%%history/r ../tmp/$session/history&quot; \
| $SED &quot;s/%%history//g&quot;\
| $SED &quot;s/%%id/$id/g&quot; \
| $SED &quot;s/%%book_id/$book_id/g&quot; \
| $SED &quot;s/%%pdls/session=$session\&amp;pin=$pin\&amp;req=get/g&quot; \
| $SED &quot;s/%%session/session=$session\&amp;pin=$pin/g&quot; \
| $SED &quot;s/%%params/subapp=location\&amp;session=$session\&amp;pin=$pin/g&quot;

--------
</code></pre>
<p><img alt="Screenshot" src="../img/book_search_master_link.png" /></p>
<h3 id="generate-form">Generate form</h3>
<p>Let's generate form for requesting book.</p>
<pre><code>sudo /usr/local/small-shell/adm/gen -app
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 2
</code></pre>
<h5 id="result-of-dialog">result of dialog</h5>
<pre><code>APP type: 2.FORM
Form name: booking_req
target_databox: request.db
description: This is request form for booking library
IP_whitelisting: no
Included keys: requester,email,book_name
Access URL: https://**-**-**/booking_req
</code></pre>
<h3 id="cook-form">Cook Form</h3>
<p>Once Form APP is generated, let's cook the codes.</p>
<ol>
<li>Insert book name using QUERY STRING</li>
<li>Booking 1 resource which is available and searchable in book.master</li>
<li>Change status of other databoxes, #book.master #book.res</li>
</ol>
<h6 id="update-controller">update controller</h6>
<pre><code>sudo vi /usr/lib/cgi-bin/booking_req
org: ../bin/booking_req_get.sh session:$session pin:$pin id:$id remote_addr:${remote_addr};;
update : ../bin/booking_req_get.sh session:$session pin:$pin id:$id remote_addr:${remote_addr} book_name:${book_name} ;;
</code></pre>
<h6 id="update-get-logic-for-loading-query-string">update get logic for loading QUERY STRING</h6>
<pre><code>sudo vi /var/www/bin/booking_req_get.sh

# block1, load book_name from controller
--code--
if [[ $param == book_name:* ]]; then
  book_name=`echo $param | $AWK -F&quot;:&quot; '{print $2}'`
fi
--------

# bock2, add book_name to new form. 
--code--
# gen reqd/write form #new
$DATA_SHELL databox:request.db action:get id:$id keys:requester,email,book_name format:html_tag &gt; ../tmp/$session/dataset.0.1
cat ../tmp/$session/dataset.0.1 \
| $SED &quot;s/name=\&quot;book_name\&quot; value=\&quot;\&quot;/name=\&quot;book_name\&quot; value=\&quot;$book_name\&quot;/g&quot; &gt; ../tmp/$session/dataset
--------

</code></pre>
<h6 id="update-app_setsh-for-updating-datasets-additionally">update $APP_set.sh for updating datasets additionally</h6>
<pre><code>sudo vi /var/www/bin/booking_req_set.sh

--code--
# load book resource
book_name=`cat ../tmp/$session/book_name`
resource_id=`$DATA_SHELL databox:book.res command:show_all[match=name{$book_name}][filter=status{on{%%%%%%%}the{%%%%%%%}shelve}] format:json \
| jq '.[] | .id'| $SED -s &quot;s/\&quot;//g&quot; | head -1`

if [ &quot;$resource_id&quot; ];then
  # push datas to databox
  echo &quot;$resource_id&quot; &gt; ../tmp/$session/book_resource_id
  echo &quot;requested&quot; &gt; ../tmp/$session/status
  keys=&quot;book_resource_id,status,$keys&quot;
  $DATA_SHELL databox:request.db action:set id:new keys:$keys input_dir:../tmp/$session  &gt; ../tmp/$session/result

  # result check
  updated_id=`cat ../tmp/$session/result | grep &quot;^successfully set&quot; | $AWK -F &quot;id:&quot; '{print $2}' | $SED '/^$/d' | sort | uniq`
  avail_num=`$DATA_SHELL databox:book.res command:show_all[match=name{$book_name}][filter=status{on{%%%%%%%}the{%%%%%%%}shelve}] format:none | wc -l`

  if [ &quot;$updated_id&quot; -a $avail_num -ge 1 ];then
    # update staus of resource.db
    $DATA_SHELL databox:book.res action:set id:$resource_id key:status value:reserved  &gt;&gt; ../tmp/$session/result

    # update status of book.master
    (( avail_num -= 1 ))
    if [ $avail_num -eq 0 ];then
      book_master_id=`$DATA_SHELL databox:book.master command:show_all[match=name{$book_name}] format:json | jq '.[] | .id'| $SED -s &quot;s/\&quot;//g&quot;`
      $DATA_SHELL databox:book.master action:set id:$book_master_id key:available value:-  &gt;&gt; ../tmp/$session/result
    fi
  fi

fi
-------
</code></pre>
<h6 id="add-reserve-button-for-book_search-app">Add reserve button for book_search APP</h6>
<pre><code>sudo vi /var/www/descriptor/book_search_get_ro.html.def
--code--
&lt;a href=&quot;./booking_req?book_name=%%book_name&quot;&gt;&lt;button class=&quot;button&quot;&gt;Reserve&lt;/button&gt;&lt;/a&gt;
--------
</code></pre>
<p><img alt="Screenshot" src="../img/book_search_reserve.png" /></p>
<h6 id="check-query-string-is-working">Check QUERY STRING is working</h6>
<p>Once you click Reserve button, request form must contain book information
<img alt="Screenshot" src="../img/book_req_form.png" /></p>
<h3 id="finalize">Finalize</h3>
<p>Add status and message to end user page</p>
<pre><code>sudo vi /var/www/bin/booking_req_get.sh
--code--
# gen read only datas
$DATA_SHELL databox:request.db action:get id:$id keys:requester,email,book_name,status,message format:none | grep -v hashid &gt; ../tmp/$session/dataset.0.1
cat ../tmp/$session/dataset.0.1 | $SED &quot;s/^/&lt;li&gt;&lt;label&gt;/g&quot; | $SED &quot;s/:/&lt;\/label&gt;&lt;pre&gt;/g&quot; | $SED &quot;s/$/&lt;\/pre&gt;&lt;\/li&gt;/g&quot; \
| $SED &quot;s/&lt;pre&gt;&lt;\/pre&gt;/&lt;pre&gt;-&lt;\/pre&gt;/g&quot; | $SED &quot;s/_%%enter_/\n/g&quot; &gt; ../tmp/$session/dataset
--------
</code></pre>
<p><img alt="Screenshot" src="../img/book_req_status.png" /></p>
<h3 id="publish-cook-book-as-a-template">Publish cook book as a template</h3>
<p>You can publish your APP template with copying bin/${APP}<em> and cgi-bin/${APP}</em> descriptor/${APP}*.
If you add deploy.sh as well to the repository, other user can import APP very easily.</p>
<pre><code>cd $HOME
git clone https://github.com/21it-org/21it/templates
cd cookbook
sudo ./deploy.sh
</code></pre>
<p>This is sample code of
<a href="https://github.com/21it-org/21it/blob/main/templates/cookbook/deploy.sh">deploy.sh</a></p>
<h4 id="published-sample-code">Published sample code</h4>
<p>please check it !
<a href="https://github.com/21it-org/21it/tree/main/templates/cookbook">cookbook on github</a></p>
<h3 id="cook-job">Cook Job</h3>
<p>Let's create job for updating available status. this job can prevent miss to update available status even if admin return book to shelve and update book resource status.</p>
<h4 id="create-batch-script">Create batch script</h4>
<p>You can use small-shell basic parameters and sys user key if you add script to util/scripts dir.</p>
<pre><code>sudo vi /usr/local/small-shell/util/scripts/status_update.sh
</code></pre>
<pre><code>#!/bin/bash
#-------------------------------------------------------------
# This is the script for update status of book.master
#-------------------------------------------------------------

# global.conf load
SCRIPT_DIR=`dirname $0`
. ${SCRIPT_DIR}/../../global.conf

# load authkey
. ${SCRIPT_DIR}/.authkey

WHOAMI=`whoami`
if [ ! &quot;$WHOAMI&quot; = &quot;small-shell&quot; ];then
  echo &quot;error: user must be small-shell&quot;
  exit 1
fi

# dump non available books
$ROOT/bin/DATA_shell authkey:$authkey databox:book.master command:show_all[keys=id,name][match=available{-}] format:csv \
&gt; ${SCRIPT_DIR}/tmp/book_master_dump.tmp

# check latest resource status
count=1
while read line
do

  if [ $count -gt 1  ];then
    book_id=`echo $line | $AWK -F &quot;,&quot; '{print $1}'`
    book_name=`echo $line | $AWK -F &quot;,&quot; '{print $2}'`

    # check on_the_shelve book
    check_shelv=`$ROOT/bin/DATA_shell authkey:$authkey databox:book.res \
    command:show_all[match=name{$book_name}][filter=status{on{%%%%%%%}the{%%%%%%%}shelve}] format:none`

    if [ &quot;$check_shelv&quot; ];then
      # update available status
      $ROOT/bin/DATA_shell authkey:$authkey databox:book.master action:set id:$book_id key:available value:yes
      echo &quot;$ROOT/bin/DATA_shell authkey:$authkey databox:book.master action:set id:$book_id key:available value:yes&quot;
    fi
  fi

  ((count += 1))

done &lt; ${SCRIPT_DIR}/tmp/book_master_dump.tmp

exit 0
</code></pre>
<h4 id="change-system-user-permission-from-read-only-to-readwrite">Change system user permission from read only to read/write</h4>
<p>Before executing the job, please change sys user permission from ro to rw.</p>
<pre><code>sudo /usr/local/small-shell/adm/ops set.attr:sys{rw}
</code></pre>
<h4 id="push-job-to-small-shell">Push job to small-shell</h4>
<p>You can put job to small-shell automation framework very easily. please check detail at <a href="../automation_tour/">e-cron</a> tour.</p>
<pre><code>sudo /usr/local/small-shell/adm/gen -job
</code></pre>
<p>Dialog will be started.</p>
<pre><code>job name: book_master_status_update
Type of job (1.job automation | 2.file exchange) : 1
--Define schedule--
Month [ any | 1-12 ]: any
Date  [ any | 1-31 ]: any
Hour  [ any | 0-23 ]: any
Min   [ any | 0-59 ]: 0
Week  [ any | mon - sun ]: any
Exec command or batch script: status_update.sh
</code></pre>
<h4 id="enable-job">Enable job</h4>
<pre><code>sudo -u small-shell /usr/local/small-shell/bin/e-cron enable.book_master_status_update
</code></pre>
<h4 id="job-check">Job check</h4>
<pre><code># check list
sudo -u small-shell ./e-cron ls
--------------------------------------------------------------
job definition: /usr/local/small-shell/util/e-cron/def
--------------------------------------------------------------
book_master_status_update.enabled
del_session.enabled
del_util_log.enabled

# exec manually
sudo -u small-shell ./e-cron exec.book_master_status_update
book_master_status_update successfully completed

# check status
sudo -u small-shell ./e-cron stat
--------------------------------------------------------
LATEST STATUS OF JOB
--------------------------------------------------------
2022-03-20 00:05:01 del_util_log successfully completed
2022-03-20 02:45:41 book_master_status_update successfully completed
2022-03-20 02:46:01 del_session successfully completed
</code></pre>
<h2 id="set-notification-mail-to-form">Set notification mail to Form</h2>
<p>In this coook, we would like to add notification mail to inquiry form of <a href="../app_shell_scratch/#team-app">Team APP</a>
. you can add same code to any Form APP.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>please set MTA such like postfix beforehand</p>
</div>
<p>Let's add code to inquiry_set.sh</p>
<pre><code># install mail comamnd
sudo apt install mailutils

# add code
vi /var/www/bin/inquiry_set.sh
</code></pre>
<p>then please add these codes just before session removal</p>
<pre><code># notification mail 
notification_addr=&quot;to_addr@XXXX.com&quot;
sender_addr=&quot;from_addr@XXXX.com&quot;
. ${small_shell_path}/web/base
echo &quot;inquiry url is here ${base_url}team?subapp=inquiries&amp;req=get&amp;id=$updated_id&quot; | mail -s &quot;New inquiry added through Form&quot; -aFrom:${sender_addr} ${notification_addr}

if [ &quot;$session&quot; ];then
  rm -rf /var/www/tmp/$session
fi
</code></pre>
<h2 id="portal-design-recipe">Portal design recipe</h2>
<p>In this section, you can learn how you can change design of main page of your APP. let's create main page with no authentication and no databox for making the easiest example. of course any type of authentication can be selected and any databox can be attached.</p>
<pre><code>sudo /usr/local/small-shell/adm/gen -app
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 3
app_name: static_site
Type of Authentication (1.shared pass | 2.user key | 3.other | 4.none): 4
primary databox: none
</code></pre>
<h3 id="cook-main-page">Cook main page</h3>
<p>Let's start to cook main page. you can edit the page by 2 way. 1 is edit the page on Base APP {$APP_UI.md.def} web UI, then portal page could be generated. </p>
<h4 id="update-appuimddef-on-base-app">Update $app.UI.md.def on <a href="../app_shell_tour/#access-url-of-base-app">Base APP</a></h4>
<p><img alt="Screenshot" src="../img/test.UI.md.def.png" /></p>
<p>You can update description using both markdown and legach HTML. 
please check the markdown grammer <a href="https://21it.org/markdown.html">here</a> if needed. 
also you can update menu,logo and footer of portal on the same admin page. 
<img alt="Screenshot" src="../img/UI.md.detail.png" /></p>
<h3 id="htmlcss-grammar">HTML/CSS Grammar</h3>
<p>Another way of updating portal is just editting hml.def directly {$APP_main.html.def} </p>
<pre><code>sudo vi /var/www/descriptor/static_site_main.html.def
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please update under "main" class, then you can use light css framework</p>
</div>
<h4 id="update-left-header">Update left header</h4>
<p>You can modify links and logo to the left header, in this example link to Docs is added.</p>
<pre><code>! please upload image file to /var/www/html
</code></pre>
<pre><code>&lt;div class=&quot;left-header&quot;&gt;
  &lt;a href=&quot;https://github.com&quot;&gt;&lt;img src=&quot;../GitHub-Mark-32px.png&quot;&gt;&lt;/a&gt;
  &lt;a href=&quot;https://small-shell.org&quot;&gt;&lt;h2&gt;Docs&lt;/h2&gt;&lt;/a&gt;
&lt;/div&gt;
</code></pre>
<h4 id="implement-flex-table">Implement flex-table</h4>
<p>For implementing table, you must use some classes. table must be contain "flext-table" class. and header should have "flex-table-header" class.</p>
<pre><code>&lt;div class=&quot;flex-table&quot;&gt;
  &lt;ul&gt;
    &lt;li class=&quot;flex-table-header&quot;&gt;
      &lt;p&gt;column1&lt;/p&gt;
      &lt;p&gt;column2&lt;/p&gt;
      &lt;p&gt;column3&lt;/p&gt;
      &lt;p&gt;column4&lt;/p&gt;
    &lt;/li&gt;
    &lt;li&gt;
      &lt;p&gt;data1.column1&lt;/p&gt;
      &lt;p&gt;data1.column2&lt;/p&gt;
      &lt;p&gt;data1.column3&lt;/p&gt;
      &lt;p&gt;data1.column4&lt;/p&gt;
     &lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;
</code></pre>
<h5 id="add-internal-page-link-to-the-left-navi">Add internal page link to the left navi</h5>
<p>In this example, page will have 3 section including table section.</p>
<pre><code>&lt;div class=&quot;left-nav&quot;&gt;
 &lt;a href=&quot;#section1&quot;&gt;&lt;p&gt;section1&lt;/p&gt;&lt;/a&gt;
 &lt;a href=&quot;#section2&quot;&gt;&lt;p&gt;section2&lt;/p&gt;&lt;/a&gt;
 &lt;a href=&quot;#section3&gt;&lt;p&gt;section3p&gt;&lt;/a&gt;
&lt;/div&gt;
</code></pre>
<h5 id="use-button">Use button</h5>
<p>Button must have "button" class.</p>
<pre><code>&lt;button class=&quot;button&quot;&gt;Sample button&lt;/button&gt;
</code></pre>
<h5 id="use-image">Use image</h5>
<p>In this example, we would like to use GitHub logo for image. please upload logo to "/var/www/html" that's static site dir. then write down the path to the HTML page.</p>
<pre><code>&lt;a href=&quot;https://github.com&quot;&gt;&lt;img src=&quot;../GitHub-Mark-32px.png&quot;&gt;&lt;/a&gt;
</code></pre>
<h5 id="update-even-menu">Update even menu</h5>
<p>In this example, links in right header menu will be external links and mail addr.</p>
<pre><code>sudo vi /var/www/descriptor/common_parts/static_site_common_menu
</code></pre>
<pre><code>&lt;li&gt;&lt;a href=&quot;&quot;&gt;LINK 1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;&quot;&gt;LINK 2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;mailto:address&quot;&gt;MAIL&lt;/a&gt;&lt;/li&gt;
</code></pre>
<p>or If you don't need to use right header, just delete right header definition on $APP_main.html.def</p>
<pre><code>sudo vi /var/www/descriptor/static_site_main.html.def
</code></pre>
<h5 id="right-header-definition-on-mainhtmldef">right header definition on main.html.def</h5>
<pre><code>&lt;div class=&quot;right-header&quot;&gt;
&lt;button class=&quot;even-btn-menu&quot;&gt;=&lt;/button&gt;
 &lt;nav&gt;
 &lt;ul&gt;
 %%common_menu
 &lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
</code></pre>
<h5 id="add-footer">Add footer</h5>
<p>Please use footer class for making footer.</p>
<pre><code>&lt;div class=&quot;footer&quot;&gt;
  &lt;p&gt;powered by small-shell.org&lt;/p&gt;
&lt;/div&gt;
</code></pre>
<h5 id="implement-form">Implement form</h5>
<p>If you want to implement form, it's recommended to use class="form-box" , please check following example.</p>
<pre><code>&lt;div class=&quot;form-box&quot;&gt;
  &lt;div class=&quot;description&quot;&gt;
    &lt;h1&gt;#new&lt;/h1&gt;
  &lt;/div&gt;
  &lt;form method=&quot;post&quot; action=&quot;&quot; onclick=&quot;document.charset='utf-8';&quot;&gt;
  &lt;ul&gt;
    &lt;li&gt;
      &lt;label&gt;name&lt;/label&gt;
      &lt;input type=&quot;text&quot; name=&quot;name&quot; value=&quot;&quot; required&gt;
    &lt;/li&gt;
    &lt;li&gt;
     &lt;label&gt;description&lt;/label&gt;
     &lt;input type=&quot;text&quot; name=&quot;description&quot; value=&quot;&quot; &gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;
</code></pre>
<h5 id="change-color">Change color</h5>
<p>You can change color by updating $APP.css.def</p>
<pre><code>sudo vi /var/www/descriptor/static_site.css.def
</code></pre>
<pre><code>#----------------classes---------------#
# Change header color
.flex-header

# Change right menu charactor
.right-header a

# Change right menu background and border color
.right-header nav 
.right-header nav.open-menu

# Change right header button (=)
.right-header .even-btn-menu

# Change button
.main button

# Change table header of main
.main .flex-table-header
#----------------------------------------#
</code></pre>
<h3 id="distribute-the-site-to-static-directory">Distribute the site to static directory</h3>
<p>You can export main page as static stie. then please copy the html to /var/www/html or other static directory.</p>
<pre><code>sudo /usr/local/small-shell/util/scripts/dist.sh $APP $EXPORT_DIR
</code></pre>
<h2 id="deploy-auto-ssl-cetificate">Deploy auto SSL cetificate</h2>
<p>In this cook, we would like to use Let's Encrypt as ssl certificate provider. and we will use certbot for the deployment. so please install certbot first.</p>
<h5 id="install-certbot">Install certbot</h5>
<pre><code>sudo snap install core
sudo snap refresh core
sudo snap install --classic certbot 
sudo ln -s /snap/bin/certbot /usr/bin/certbot
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A record of the domain must be set on DNS server beforehand. and it must has global IP to be IP reachable from Let's encrypt server </p>
</div>
<h5 id="launch-base-app-with-fqdn-for-certification">Launch Base APP with FQDN for certification</h5>
<p>To be verified your domain by Let's Encrypt server, please launch WEB server with FQDN name that you want to deploy ssl certificate and the FQDN name must be same as A record of DNS.so far http should be fine because certificate is not issued yet. deploy job will upgrade it to https later.</p>
<pre><code>sudo /usr/local/small-shell/adm/gen -app
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 1
Type of server (1.small-shell WEB srv | 2.other WEB srv): 1
protocol (http | https): http
WEB Server FQDN or IP addr (e.g. 192.168.10.1): $FQDN
</code></pre>
<h4 id="import-job-and-deploy-ssl-certificate">Import job and deploy ssl certificate</h4>
<p>Once you install certbot and launched Base APP using small-shell web, let's kick deploy.sh. then dialog will be started. please answer your mail address that is reqiured to publish certificate by Let's Encrypt</p>
<pre><code>cd $HOME
git clone https://github.com/naruoken/small-shell-apps
cd ./small-shell-apps/ssl_auto
chmod 755 deploy.sh
sudo ./deploy.sh
</code></pre>
<h4 id="enable-auto-refresh">Enable auto refresh</h4>
<p>You must add following setting on sudoers.</p>
<pre><code>sudo visudo
# add following to bottom of the file, if there is no small-shell entry
small-shell   ALL=(ALL:ALL)    NOPASSWD: /usr/local/small-shell/adm/*, /usr/local/small-shell/util/scripts/*
</code></pre>
<h2 id="backup-restore-example">Backup &amp; Restore example</h2>
<p>In this cook, 1 production node will send backup to backuo node through e-cron HUB API</p>
<pre><code>| prod node | -- | backup node #e-cron HUB|
</code></pre>
<h4 id="usage-of-bkup-and-rstr">Usage of bkup and rstr</h4>
<pre><code>sudo /usr/local/small-shell/adm/bkup $dir
sudo /usr/local/small-shell/adm/rstr $dir
</code></pre>
<h4 id="operation-at-backup-node">Operation at backup node</h4>
<p>It's required to Launch Base APP and check e-cron URL and key</p>
<pre><code>sudo /usr/local/small-shell/adm/gen -app 
cat /usr/local/small-shell/web/base | grep hubapi
cat /usr/local/small-shell/web/base | grep api_authkey
</code></pre>
<h4 id="operation-at-production-node">Operation at production node</h4>
<p>Once e-cron HUB is ready, let's define backup &amp; sync job on pdocution node. bkup command will backup every data of small-shell including user info, databox{data,log}, APP, Job... and sudo privilede is required for executing bkup command. please add sudoers beforehand. </p>
<pre><code>sudo visudo
# add folowing line, if there is no small-shell entry
small-shell   ALL=(ALL:ALL)    NOPASSWD: /usr/local/small-shell/adm/*, /usr/local/small-shell/util/scripts/*

# define backup job@production node
sudo /usr/local/small-shell/adm/gen -job
job name: backup
Type of job (1.job automation | 2.file exchange) : 1
--Define schedule--
Month [ any | 1-12 ]: any
Date  [ any | 1-31 ]: any
Hour  [ any | 0-23 ]: 0 
Min   [ any | 0-59 ]: 1
Week  [ any | mon - sun ]: any
Exec command or batch script: sudo /usr/local/small-shell/adm/bkup /var/tmp

# define push job@production to backup node, please confirm URL and authkey at backup node beforehand
sudo /usr/local/small-shell/adm/gen -job
Type of job (1.job automation | 2.file exchange) : 2
--Define schedule--
Month [ any | 1-12 ]: any
Date  [ any | 1-31 ]: any
Hour  [ any | 0-23 ]: 1
Min   [ any | 0-59 ]: 0
Week  [ any | mon - sun ]: any
Type of file exchange (push | get): push
local directory: /var/tmp
file_name: *tar.xz
HUB API URL: $hubapi
API authkey: $api_authkey
</code></pre>
<h4 id="restore">Restore</h4>
<p>You can restore to backup node by rstr command. file will be uploaded to e-cron HUB que/file directory as default.  </p>
<pre><code>ls /usr/local/small-shell/util/e-cron/que/file
sudo /usr/local/small-shell/adm/rstr /usr/local/small-shell/util/e-cron/que/file
</code></pre>
<p>Once restore completed, plase regenerate BaseAPP and enable jobs</p>
<pre><code>sudo /usr/local/small-shell/adm/gen -app
sudo -u small-shell /usr/local/small-shell/bin/e-cron enable.XXX
</code></pre>
<h2 id="log-analyzer">Log analyzer</h2>
<p>You can import job for analyzing small-shell web log from github. please deploy it to the small-shell env which using default web server.</p>
<h6 id="link-to-code-is-here">Link to code is  <a href="https://github.com/naruoken/small-shell-apps">here</a></h6>
<pre><code>sudo apt-get install whois
cd $HOME
git clone https://github.com/naruoken/small-shell-apps
cd small-shell-apps/ssw_log_analyzer

# Deploy job
sudo ./deploy.sh
</code></pre>
<h4 id="confirm-imported-job">confirm imported job</h4>
<p>If deploy.sh executed without any error, 1 databox {web_analyer} and 3 job will be imported.</p>
<h6 id="log-analyzer_1">log analyzer</h6>
<pre><code>sudo -u small-shell /usr/local/small-shell/bin/e-cron cat.ssw_log_analyzer
</code></pre>
<pre><code> &gt; JOB: ssw_log_analyzer
def:/usr/local/small-shell/util/e-cron/def/ssw_log_analyzer.def
-------------SCHEDULE----------------
min: 1
hour: 0
date: any
month: any
week: any
-------------DEFINITION----------------
exec_command=&quot;/usr/local/small-shell/util/scripts/ssw_log_analyzer.sh&quot;
input_message=&quot;&quot;
output_message=&quot;analyzer.done&quot;
hubapi=&quot;&quot;
api_authkey=&quot;&quot;
</code></pre>
<h6 id="page-view">page view</h6>
<pre><code>sudo -u small-shell /usr/local/small-shell/bin/e-cron cat.pv_statistics
</code></pre>
<pre><code> &gt; JOB: pv_statistics
def:/usr/local/small-shell/util/e-cron/def/pv_statistics.def
-------------SCHEDULE----------------
min: 0
hour: 1
date: any
month: any
week: any
-------------DEFINITION----------------
exec_command=&quot;/usr/local/small-shell/util/scripts/sumup.sh type:line sumup_key:pv frequency:daily title:pv set_time:\&quot;`date +%Y-%m-%d --date '1 day ago'`\&quot; global_filter:\&quot;`date +%Y-%m-%d --date '1 day ago'`\&quot; databox:web_analyzer&quot;
input_message=&quot;analyzer.done&quot;
output_message=&quot;pv.done&quot;
hubapi=&quot;&quot;
api_authkey=&quot;&quot;
</code></pre>
<h6 id="uniq-access">Uniq access</h6>
<pre><code>sudo -u small-shell /usr/local/small-shell/bin/e-cron cat.uniq_statistics
</code></pre>
<pre><code> &gt; JOB: uniq_statistics
def:/usr/local/small-shell/util/e-cron/def/uniq_statistics.def
-------------SCHEDULE----------------
min: 10
hour: 1
date: any
month: any
week: any
-------------DEFINITION----------------
exec_command=&quot;/usr/local/small-shell/util/scripts/sumup.sh type:line sumup_key:uniq_access frequency:daily title:pv set_time:\&quot;`date +%Y-%m-%d --date '1 day ago'`\&quot; global_filter:\&quot;`date +%Y-%m-%d --date '1 day ago'`\&quot; databox:web_analyzer&quot;
input_message=&quot;pv.done&quot;
output_message=&quot;&quot;
hubapi=&quot;&quot;
api_authkey=&quot;&quot;
</code></pre>
<h4 id="confirm-result">Confirm result</h4>
<p>Job will push the result to the databox named as web_annalyzer. Log analytics target is srvdump.log.1 it means 1 day ago log. you can check the graph on console. using #stats command.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>

        <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
