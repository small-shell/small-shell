<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Cook Book - small-shell.org</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/docco.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'G-ECCJ0KEWFN', 'auto');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">small-shell.org</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Quick Start <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../quick_start_linux/" class="dropdown-item">For ubuntu or debian</a>
</li>
                                    
<li>
    <a href="../quick_start_linux_apache2/" class="dropdown-item">For ubuntu + apache2 </a>
</li>
                                    
<li>
    <a href="../quick_start_Mac/" class="dropdown-item">For macOS</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Shell tour <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../app_shell_tour/" class="dropdown-item">APP Shell</a>
</li>
                                    
<li>
    <a href="../data_shell_tour/" class="dropdown-item">DATA Shell</a>
</li>
                                    
<li>
    <a href="../app_shell_form/" class="dropdown-item">Create Form</a>
</li>
                                    
<li>
    <a href="../app_shell_scratch/" class="dropdown-item">Create Scratch APP</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Cook Book</a>
</li>
                                    
<li>
    <a href="../automation_tour/" class="dropdown-item">E-cron (Automate & dataExchange)</a>
</li>
                                    
<li>
    <a href="../python_tour/" class="dropdown-item">Pyshell</a>
</li>
                                    
<li>
    <a href="../auth_shell/" class="dropdown-item">Auth</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../app_shell_scratch/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../automation_tour/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#cook-book" class="nav-link">Cook book</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#cook-prototype-app" class="nav-link">Cook prototype APP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#set-notification-mail" class="nav-link">Set notification mail</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#portal-design-recipe" class="nav-link">Portal design recipe</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#automate-ssl-cert-deployment" class="nav-link">Automate SSL cert deployment</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#make-replica-for-load-balancing" class="nav-link">Make replica for load balancing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#backup-restore-example" class="nav-link">Backup &amp; Restore example</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#dictionary-create-lang-pack" class="nav-link">Dictionary (create lang pack)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#log-analyzer" class="nav-link">Log analyzer</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="cook-book">Cook book</h1>
<p>In this course, you can learn how utilize APPs { Base APP, Scratch APP, Form } and recipe of design change of HTML/CSS descriptor.also you can learn how to use utilities such like ssl cert deploy automation, enable replication with several hosts and so on.</p>
<h2 id="cook-prototype-app">Cook prototype APP</h2>
<p>In this prototype APP construction work, these APPs in the chart will be created. </p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Databox</th>
<th>User</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>-</td>
<td>Base APP</td>
<td>ALL</td>
<td>Admin</td>
<td>Manage ALL data as admin #need key authentication</td>
</tr>
<tr>
<td>book_search</td>
<td>Scratch APP</td>
<td>book.master</td>
<td>End user</td>
<td>Allow limitted access to the master data</td>
</tr>
<tr>
<td>location_search</td>
<td>Sub APP of book_search</td>
<td>book.res</td>
<td>End user</td>
<td>Allow limitted access to the resource and location data</td>
</tr>
<tr>
<td>booking_req</td>
<td>Form</td>
<td>request.db</td>
<td>End user</td>
<td>Provide request Form to end user</td>
</tr>
</tbody>
</table>
<p>Here is <a href="https://github.com/21it-org/21it/tree/main/templates/cookbook">sample code</a> of above APPs. it will be explained step by step in this section.</p>
<h3 id="create-databox">Create Databox</h3>
<p>3 databoxes will be used for the prototype APP. "book.master" will be master data of book information, "book.res" is resource information including location information each resource, and "request.db" is databox for putting request from end user.</p>
<pre><code> # db relation 
 book.master &lt;-reference- book.res &lt;--reference-- request.db

 # detail
 1. book.master { name: text, isbn: num, author: text, category: select, desciption: textarea, available: checkbox}
 2. book.res  { hashid, name: pdls(book.master), location: select, status: select}
 3. request.db  { hashid, requester: text, email: email, book_name: text, status: select, book_resource: pdls(book.res), message: textarea }

</code></pre>
<h4 id="import-databox">Import databox</h4>
<p>Import databox, using db.def</p>
<pre><code>cd $HOME
git clone https://github.com/21it-org/21it.git
cd 21it/templates/cookbook/def
sudo /usr/local/small-shell/util/scripts/bat_gen.sh ./book_master.def
sudo /usr/local/small-shell/util/scripts/bat_gen.sh ./book_res.def
sudo /usr/local/small-shell/util/scripts/bat_gen.sh ./request.db.def
</code></pre>
<h3 id="launch-base-app">Launch Base APP</h3>
<p>Launch Base APP by refering to <a href="../quick_start_linux/">Quick start</a></p>
<pre><code>$ sudo /usr/local/small-shell/adm/gen -app
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 1  
#-&gt; Dialog will be started, for making Base APP
</code></pre>
<h3 id="create-scratch-app">Create scratch APP</h3>
<p>Once databoxes and Base APP is created, let's move on to create APPs. </p>
<h4 id="create-main-app">Create Main APP</h4>
<pre><code>$ sudo /usr/local/small-shell/adm/gen -app 
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 3
APP Name: book_search
Type of Authentication (1.shared pass | 2.user key | 3.other | 4.none): 4
Primary databox: book.master
</code></pre>
<h4 id="add-sub-app">Add sub APP</h4>
<p>Add databox to Main APP by utilizing sub APP. this sub APP is used for searching book resource and location.</p>
<pre><code>$ sudo /usr/local/small-shell/adm/gen -app 
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 3
APP Name: location_search@book_search
Subapp databox: book.res
</code></pre>
<h3 id="cook-app">Cook APP</h3>
<p>Once APPs are generated, let's modify them 1 by 1. you can check <a href="https://github.com/21it-org/21it/tree/main/templates/cookbook">sample code</a> as reference</p>
<h4 id="update-portal">update portal</h4>
<p>Portal page of book_search can be editted by both markdown grammer and legacy HTML tag, detail is in 
<a href="./#portal-design-recipe">Cook main page</a> section. you can also update menu of book_search on the Base APP.</p>
<p><img alt="Screenshot" src="../img/book_search_portal.png" /></p>
<h4 id="insert-code-to-description">Insert code to description</h4>
<p>In this prototype APP, very simple description is written on the portal as below. it's using both HTML tag and markdown.</p>
<pre><code>&lt;h1&gt;This is book search APP. you can search and request book for lending on this APP.&lt;/h1&gt;

    STEP1: Search book from table
    STEP2: Request from book page, then you can get your request link
    STEP3: Message will be updated once admin check your request on your link, then you can get the book when you come to office

&lt;a href=&quot;./book_search?req=table&quot;&gt;&lt;button class=&quot;button&quot;&gt;Search&lt;/button&gt;&lt;/a&gt;
</code></pre>
<p><img alt="Screenshot" src="../img/update_book_search_portal.png" />
Updated portal is here.
<img alt="Screenshot" src="../img/updated_book_search_portal.png" /></p>
<h4 id="add-logics-to-the-app">Add logics to the APP</h4>
<p>In this example, adding following functions to book_search APP</p>
<ol>
<li>Add link from master data to resource table</li>
<li>Filter table to show only available data</li>
<li>Restrict key</li>
<li>Add link from resource data to master data</li>
</ol>
<h5 id="add-link-from-master-data-to-resource-table">Add link from master data to resource table</h5>
<p>Meta command can generate link that can be used in html.def.</p>
<pre><code># generate link of location_search(subapp)
$ sudo -u small-shell /usr/local/small-shell/bin/meta get.link:location_search@book_search
APP:location_search@book_search
Table: &lt;a href=&quot;./book_search?%%session&amp;subapp=location_search&amp;req=table&quot;&gt;link&lt;/a&gt;
DATA.new: &lt;a href=&quot;./book_search?%%session&amp;subapp=location_search&amp;req=get&amp;id=new&quot;&gt;link&lt;/a&gt;
DATA.$id: &lt;a href=&quot;./book_search?%%session&amp;subapp=location_search&amp;req=get&amp;id=$id&quot;&gt;link&lt;/a&gt;
</code></pre>
<p>then copy and paste to action link field with adding "table_command=%%book_name" for filtering table with book name.</p>
<pre><code>$ sudo vi /var/www/descriptor/book_search_get_ro.html.def
--code--
&lt;div class=&quot;action_links&quot;&gt;
  &lt;!-- add following line --&gt;
  &lt;span&gt;&lt;a href=&quot;./book_search?%%session&amp;subapp=location_search&amp;req=table&amp;table_command=%%book_name&quot;&gt;&lt;p&gt;location table&lt;/p&gt;&lt;/a&gt;&lt;/span&gt;
&lt;/div&gt;
--------
</code></pre>
<p>To insert %%book_name in above action link, need to add these logics to get action.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you insert sed or awk in codes, it's recommended to used $SED and $AWK value. the parameter is defined at /usr/local/small-shlel/global.conf</p>
</div>
<pre><code>$ sudo vi /var/www/bin/book_search_get.sh
# block1 { get ID book_namd }, adding to next line of DATA_SHELL setting
--block1 code--
DATA_SHELL=&quot;${small_shell_path}/bin/DATA_shell session:$session pin:$pin app:book_search&quot;
# add block1
book_name=`$DATA_SHELL databox:book.master action:get key:name id:$id format:none | $AWK -F &quot;:&quot; '{print $2}'`
--------
# update render HTML logic as block 2
--block2 code--
# render HTML
cat ../descriptor/${view} | $SED &quot;s/^ *&lt;/&lt;/g&quot; \
| $SED &quot;/%%common_menu/r ../descriptor/common_parts/book_search_common_menu&quot; \
| $SED &quot;/%%common_menu/d&quot; \
| $SED &quot;/%%dataset/r ../tmp/$session/dataset&quot; \
| $SED &quot;s/%%dataset//g&quot;\
| $SED &quot;/%%history/r ../tmp/$session/history&quot; \
| $SED &quot;s/%%history//g&quot;\
| $SED &quot;s/%%id/$id/g&quot; \
| $SED &quot;s/%%book_name/$book_name/g&quot; \
| $SED &quot;s/%%pdls/session=$session\&amp;pin=$pin\&amp;req=get/g&quot; \
| $SED &quot;s/%%session/session=$session\&amp;pin=$pin/g&quot; \
| $SED &quot;s/%%params/session=$session\&amp;pin=$pin/g&quot;
--------
</code></pre>
<p><img alt="Screenshot" src="../img/book_search_location_link.png" /></p>
<h5 id="filter-table-to-show-only-available-data-that-is-available">Filter table to show only available data that is available</h5>
<p>To show only available book, add "match" option to show_all command. 
Following example is replacing show_all command at once using sed command.</p>
<pre><code># get backup
cp /var/www/bin/book_search_table.sh /var/tmp/book_search_table.sh.org

# replace at once
cat /var/www/bin/book_search_table.sh | sed &quot;s/command:show_all/command:show_all[match=available{yes}]/g&quot; &gt; /var/tmp/new_book_search_table.sh

# check difference
diff /var/www/bin/book_search_table.sh /var/tmp/new_book_search_table.sh 

# overwrite
sudo mv /var/tmp/new_book_search_table.sh /var/www/bin/book_search_table.sh
sudo chmod 755 /var/www/bin/book_search_table.sh 
sudo chown small-shell:small-shell /var/www/bin/book_search_table.sh
</code></pre>
<p>Then let's modify line calculation logic as well. </p>
<pre><code>$ sudo vi /var/www/bin/book_search_table.sh
# comment out original line
#line_num=`$META get.num:$databox`
# insert new line
line_num=`$DATA_SHELL databox:$databox command:show_all[match=available{yes}][sort=${sort_option},${sort_col}] format:none | wc -l | tr -d &quot; &quot;`
</code></pre>
<h5 id="restrict-key">Restrict key</h5>
<p>To restrict accessable key, change "all" to specific keys.</p>
<pre><code>$ sudo vi /var/www/bin/location_search_get.sh
# -&gt; change keys from &quot;all&quot; to specific keys.
keys=&quot;hashid,name,location&quot;
</code></pre>
<pre><code>$ sudo vi /var/www/bin/location_search_table.sh
# -&gt; change keys from &quot;all&quot; to specific keys.
keys=&quot;hashid,name,location&quot;
</code></pre>
<h5 id="add-link-from-resource-data-to-master-data">Add link from resource data to master data</h5>
<p>To connecing APPs each other, execute meta command again.</p>
<pre><code># generate link of book_search(parent app)
$ sudo -u small-shell /usr/local/small-shell/bin/meta get.link:book_search
APP:book_search
Table: &lt;a href=&quot;./book_search?%%session&amp;req=table&quot;&gt;link&lt;/a&gt;
DATA.new: &lt;a href=&quot;./book_search?%%session&amp;req=get&amp;id=new&quot;&gt;link&lt;/a&gt;
DATA.$id: &lt;a href=&quot;./book_search?%%session&amp;req=get&amp;id=$id&quot;&gt;link&lt;/a&gt;
</code></pre>
<p>then copy and past the link to action_link field.</p>
<pre><code>$ sudo vi /var/www/descriptor/location_search_get_ro.html.def
--code--
&lt;div class=&quot;action_links&quot;&gt;
  &lt;!-- add following line --&gt;
  &lt;span&gt;&lt;a href=&quot;./book_search?%%session&amp;req=get&amp;id=%%book_id&quot;&gt;&lt;p&gt;Master data&lt;/p&gt;&lt;/a&gt;&lt;/span&gt;
&lt;/div&gt;
--------
</code></pre>
<p>To insert %%book_id to action_link, let's modify render logics to get action.</p>
<pre><code>$ sudo vi /var/www/bin/location_search_get.sh
--code--
# render HTML
resource_id=$id
book_name=`$DATA_SHELL databox:book.res action:get key:name id:$id format:none | $AWK -F &quot;:&quot; '{print $2}'`
book_id=`$DATA_SHELL databox:book.master command:show_all[match=name{$book_name}] format:json | jq '.[] | .id'| $SED -s &quot;s/\&quot;//g&quot;`

cat ../descriptor/${view} | $SED &quot;s/^ *&lt;/&lt;/g&quot; \
| $SED &quot;/%%common_menu/r ../descriptor/common_parts/book_search_common_menu&quot; \
| $SED &quot;/%%common_menu/d&quot; \
| $SED &quot;/%%dataset/r ../tmp/$session/dataset&quot; \
| $SED &quot;s/%%dataset//g&quot;\
| $SED &quot;/%%history/r ../tmp/$session/history&quot; \
| $SED &quot;s/%%history//g&quot;\
| $SED &quot;s/%%id/$id/g&quot; \
| $SED &quot;s/%%book_id/$book_id/g&quot; \
| $SED &quot;s/%%pdls/session=$session\&amp;pin=$pin\&amp;req=get/g&quot; \
| $SED &quot;s/%%session/session=$session\&amp;pin=$pin/g&quot; \
| $SED &quot;s/%%params/subapp=location_search\&amp;session=$session\&amp;pin=$pin/g&quot;

--------
</code></pre>
<p><img alt="Screenshot" src="../img/book_search_master_link.png" /></p>
<h3 id="generate-form">Generate form</h3>
<p>Form for requesting book exmpale is as following. </p>
<pre><code>$ sudo /usr/local/small-shell/adm/gen -app
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 2
</code></pre>
<h5 id="result-of-dialog">result of dialog</h5>
<pre><code>APP Type: 2.FORM
Form Name: booking_req
Target Databox: request.db
Description: This is request Form for booking library
IP_whitelisting: no
Included keys: requester,email,book_name
Access URL: https://**-**-**/booking_req
</code></pre>
<p><img alt="Screenshot" src="../img/booking_req.png" /></p>
<h3 id="cook-form">Cook Form</h3>
<p>Once Form APP is generated, let's add these additional functioncs to the code.</p>
<ol>
<li>Insert book name using QUERY STRING</li>
<li>Booking 1 resource which is available and searchable in book.master</li>
<li>Change status of other databoxes, #book.master #book.res</li>
</ol>
<h5 id="update-controller">update controller</h5>
<p>Controller can load any query string in the URL and it can pass the parameter to action script. in this example, controller will pass book_name additionally to get.sh  </p>
<pre><code>$ sudo vi /var/www/cgi-bin/booking_req
--code--
# comment out original line
#/var/www/bin/booking_req_get.sh session:$session pin:$pin id:$id remote_addr:${remote_addr};;
# insert new line
/var/www/bin/booking_req_get.sh session:$session pin:$pin id:$id remote_addr:${remote_addr} book_name:${book_name} ;;
--------
</code></pre>
<h5 id="update-get-logic-of-action-script">update get logic of action script</h5>
<p>For the next, update action script to insert book name.</p>
<pre><code>$ sudo vi /var/www/bin/booking_req_get.sh

# block1 logic next line of id param loading.
--code--
  if [[ $param == id:* ]]; then
    id=`echo $param | $AWK -F&quot;:&quot; '{print $2}'`
  fi
   # add block1
   if [[ $param == book_name:* ]]; then
      book_name=`echo $param | $AWK -F&quot;:&quot; '{print $2}'`
   fi
--------

# block2, modify gen new logic. in this example, original line is comment out and new line is inserted 
--code--
# gen reqd/write form #new
# comment out original line
#$DATA_SHELL databox:request.db action:get id:$id keys:requester,email,book_name format:html_tag &gt; /var/www/tmp/$session/dataset

# insert line new lines
$DATA_SHELL databox:request.db action:get id:$id keys:requester,email,book_name format:html_tag &gt; ../tmp/$session/dataset.0.1
cat ../tmp/$session/dataset.0.1 \
| $SED &quot;s/name=\&quot;book_name\&quot; value=\&quot;\&quot;/name=\&quot;book_name\&quot; value=\&quot;$book_name\&quot;/g&quot; &gt; ../tmp/$session/dataset
--------

</code></pre>
<h4 id="add-reserve-button-for-book_search-app">Add reserve button for book_search APP</h4>
<p>Add reserve button that will link to booking_req Form with book_name. the Query string in the URL will be handled by Form controller. </p>
<pre><code>$ sudo vi /var/www/descriptor/book_search_get_ro.html.def
--code--
&lt;a href=&quot;./booking_req?book_name=%%book_name&quot;&gt;&lt;button class=&quot;button&quot;&gt;Reserve&lt;/button&gt;&lt;/a&gt;
--------
</code></pre>
<p><img alt="Screenshot" src="../img/book_search_reserve.png" /></p>
<p>Once you click Reserve button, request Form must contain book information as following.
<img alt="Screenshot" src="../img/book_req_form.png" /></p>
<h3 id="finalize-app">Finalize APP</h3>
<h5 id="update-set-logic-of-request-form">Update Set logic of request Form</h5>
<p>Basially "set logic" of request Form will update only request.db. but in this example, "set logic" will update book.res data as well to prevent double booking.</p>
<p>1st step is just comment out original logic.</p>
<pre><code>$ sudo vi /var/www/bin/booking_req_set.sh
--code--
# push datas to databox
#$DATA_SHELL databox:request.db action:set id:$id keys:$keys input_dir:/var/www/tmp/$session  &gt; /var/www/tmp/$session/result

# result check
#updated_id=`cat /var/www/tmp/$session/result | grep &quot;^successfully set&quot; | $AWK -F &quot;id:&quot; '{print $2}' | $SED '/^$/d' | sort | uniq`
--------
</code></pre>
<p>2nd step is to insert new lines right after original logic that was comment out.</p>
<pre><code>$ sudo vi /var/www/bin/booking_req_set.sh
--code--
# load book resource
book_name=`cat ../tmp/$session/book_name`
resource_id=`$DATA_SHELL databox:book.res command:show_all[match=name{$book_name}][filter=status{on{%%%%%%%}the{%%%%%%%}shelve}] format:json \
| jq '.[] | .id'| $SED -s &quot;s/\&quot;//g&quot; | head -1`

if [ &quot;$resource_id&quot; ];then
  # push datas to databox
  echo &quot;$resource_id&quot; &gt; ../tmp/$session/book_resource_id
  echo &quot;requested&quot; &gt; ../tmp/$session/status
  keys=&quot;book_resource_id,status,$keys&quot;
  $DATA_SHELL databox:request.db action:set id:new keys:$keys input_dir:../tmp/$session  &gt; ../tmp/$session/result

  # result check
  updated_id=`cat ../tmp/$session/result | grep &quot;^successfully set&quot; | $AWK -F &quot;id:&quot; '{print $2}' | $SED '/^$/d' | sort | uniq`
  avail_num=`$DATA_SHELL databox:book.res command:show_all[match=name{$book_name}][filter=status{on{%%%%%%%}the{%%%%%%%}shelve}] format:none | wc -l`

  if [ &quot;$updated_id&quot; -a $avail_num -ge 1 ];then
    # update staus of resource.db
    $DATA_SHELL databox:book.res action:set id:$resource_id key:status value:reserved  &gt;&gt; ../tmp/$session/result

    # update status of book.master
    (( avail_num -= 1 ))
    if [ $avail_num -eq 0 ];then
      book_master_id=`$DATA_SHELL databox:book.master command:show_all[match=name{$book_name}] format:json | jq '.[] | .id'| $SED -s &quot;s/\&quot;//g&quot;`
      $DATA_SHELL databox:book.master action:set id:$book_master_id key:available value:-  &gt;&gt; ../tmp/$session/result
    fi
  fi
fi
</code></pre>
<h4 id="add-status-and-message-to-end-user-page">Add status and message to end user page</h4>
<p>Originally Form contained only these fields { requester,email,book_name} but end user msut want to know the booking status. so lets show these messages.</p>
<h5 id="before-adding-logic-request">before adding logic request</h5>
<p><img alt="Screenshot" src="../img/requested_form.png" /></p>
<pre><code>$ sudo vi /var/www/bin/booking_req_get.sh

--code--
# gen read only contents
# comment out original lines
#$DATA_SHELL databox:request.db action:get id:$id keys:requester,email,book_name format:none &gt; /var/www/tmp/$session/dataset.0.1
#cat /var/www/tmp/$session/dataset.0.1 | $SED &quot;s/^/&lt;li&gt;&lt;label&gt;/g&quot; | $SED &quot;s/:/&lt;\/label&gt;&lt;pre&gt;/1&quot; | $SED &quot;s/$/&lt;\/pre&gt;&lt;\/li&gt;/g&quot; \
#| $SED &quot;s/&lt;pre&gt;&lt;\/pre&gt;/&lt;pre&gt;-&lt;\/pre&gt;/g&quot; | $SED &quot;s/_%%enter_/\n/g&quot; &gt; /var/www/tmp/$session/dataset

# insert new lines 
$DATA_SHELL databox:request.db action:get id:$id keys:requester,email,book_name,status,message format:none | grep -v hashid &gt; ../tmp/$session/dataset.0.1
cat ../tmp/$session/dataset.0.1 | $SED &quot;s/^/&lt;li&gt;&lt;label&gt;/g&quot; | $SED &quot;s/:/&lt;\/label&gt;&lt;pre&gt;/g&quot; | $SED &quot;s/$/&lt;\/pre&gt;&lt;\/li&gt;/g&quot; \
| $SED &quot;s/&lt;pre&gt;&lt;\/pre&gt;/&lt;pre&gt;-&lt;\/pre&gt;/g&quot; | $SED &quot;s/_%%enter_/\n/g&quot; &gt; ../tmp/$session/dataset
--------
</code></pre>
<h5 id="updated-image">updated image</h5>
<p><img alt="Screenshot" src="../img/new_requested_form.png" /></p>
<h3 id="cook-job-for-the-app">Cook Job for the APP</h3>
<p>In thie example, create job for updating available status. this job will be effective in the case that book was returned to shelve but admin missed to set available on book.master even if admin updated book.res status to on the shelve. job will check inconsistency between book.master and correct it accordingly.  </p>
<h4 id="create-batch-script">Create batch script</h4>
<p>You can use small-shell basic parameters and sys user's key if you put script to util/scripts dir.
by the way sys user is default user that will be created automatically when execute gen command.</p>
<pre><code>sudo vi /usr/local/small-shell/util/scripts/status_update.sh
</code></pre>
<p>copy and paste these codes. this script will work as e-cron job.
By the way underba is meta charactor of small-shell. you need to use {%%%%%%%} instead. I mean on{%%%%%%%}the{%%%%%%%}shelve} will be translated to on_the_shelve. for more detail, please check <a href="../data_shell_tour/#meta-charactors">meta charactor</a></p>
<pre><code>#!/bin/bash
#-------------------------------------------------------------
# This is the script for update status of book.master
#-------------------------------------------------------------

# global.conf load
SCRIPT_DIR=`dirname $0`
. ${SCRIPT_DIR}/../../global.conf

# load authkey
. ${SCRIPT_DIR}/.authkey

WHOAMI=`whoami`
if [ ! &quot;$WHOAMI&quot; = &quot;small-shell&quot; ];then
  echo &quot;error: user must be small-shell&quot;
  exit 1
fi

# dump non available books
$ROOT/bin/DATA_shell authkey:$authkey databox:book.master command:show_all[keys=id,name][match=available{-}] format:csv \
&gt; ${SCRIPT_DIR}/tmp/book_master_dump.tmp

# check latest resource status
count=1
while read line
do

  if [ $count -gt 1  ];then
    book_id=`echo $line | $AWK -F &quot;,&quot; '{print $1}'`
    book_name=`echo $line | $AWK -F &quot;,&quot; '{print $2}'`

    # check on_the_shelve book
    check_shelv=`$ROOT/bin/DATA_shell authkey:$authkey databox:book.res \
    command:show_all[match=name{$book_name}][filter=status{on{%%%%%%%}the{%%%%%%%}shelve}] format:none`

    if [ &quot;$check_shelv&quot; ];then
      # update available status
      $ROOT/bin/DATA_shell authkey:$authkey databox:book.master action:set id:$book_id key:available value:yes
      echo &quot;$ROOT/bin/DATA_shell authkey:$authkey databox:book.master action:set id:$book_id key:available value:yes&quot;
    fi
  fi

  ((count += 1))

done &lt; ${SCRIPT_DIR}/tmp/book_master_dump.tmp

exit 0
</code></pre>
<h4 id="change-permission-and-ower-of-the-script">Change permission and ower of the script</h4>
<pre><code>sudo cdmod 755 /usr/local/small-shell/util/scripts/status_update.sh
sudo chown small-shell:small-shell /usr/local/small-shell/util/scripts/status_update.sh
</code></pre>
<h4 id="change-system-user-permission-from-read-only-to-readwrite">Change system user permission from read only to read/write</h4>
<p>Before executing the job, please change sys user permission from ro to rw.</p>
<pre><code>sudo /usr/local/small-shell/adm/ops set.attr:sys{rw}
</code></pre>
<h4 id="push-job-to-small-shell">Push job to small-shell</h4>
<p>Once script are created, make e-cron job as following. as for detail e-cron, please check <a href="../automation_tour/">here</a> tour.</p>
<pre><code>sudo /usr/local/small-shell/adm/gen -job
</code></pre>
<p>Dialog will be started.</p>
<pre><code>Job Name: book_master_status_update
Type of job (1.job automation | 2.file exchange) : 1
--Define schedule--
Month [ any | 1-12 ]: any
Date  [ any | 1-31 ]: any
Hour  [ any | 0-23 ]: 1
Min   [ any | 0-59 ]: 0
Week  [ any | mon - sun ]: any
Exec command or batch script: status_update.sh
</code></pre>
<h4 id="enable-job">Enable job</h4>
<pre><code>sudo -u small-shell /usr/local/small-shell/bin/e-cron enable.book_master_status_update
</code></pre>
<h4 id="job-check">Job check</h4>
<pre><code># check list
$ sudo -u small-shell /usr/local/small-shell/bin/e-cron ls
--------------------------------------------------------------
job definition: /usr/local/small-shell/util/e-cron/def
--------------------------------------------------------------
book_master_status_update.enabled
del_session.enabled
del_util_log.enabled

# exec manually
$ sudo -u small-shell /usr/local/small-shell/bin/e-cron exec.book_master_status_update
book_master_status_update successfully completed

# check status
$ sudo -u small-shell /usr/local/small-shell/bin/e-cron stat
--------------------------------------------------------
LATEST STATUS OF JOB
--------------------------------------------------------
2022-03-20 00:05:01 del_util_log successfully completed
2022-03-20 02:45:41 book_master_status_update successfully completed
2022-03-20 02:46:01 del_session successfully completed
</code></pre>
<p>Once job is implemented, your prototype APP deployment is completed. please use it and have a fun!</p>
<h2 id="set-notification-mail">Set notification mail</h2>
<p>In this section, you can learn how to add notification mail to inquiry Form of <a href="../app_shell_scratch/#team-app">Team APP</a>
. you can add same code to any Form APP.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>please set MTA such like postfix beforehand</p>
</div>
<p>Let's add code to inquiry_set.sh</p>
<pre><code># install mail comamnd
sudo apt install mailutils
</code></pre>
<p>then please add these codes just before session removal logic.</p>
<pre><code>sudo vi /var/www/bin/inquiry_set.sh
</code></pre>
<pre><code># ---start insert code ----
notification_addr=&quot;to_addr@XXXX.com&quot;
sender_addr=&quot;from_addr@XXXX.com&quot;
. ${small_shell_path}/web/base
echo &quot;inquiry url is here ${base_url}team?subapp=inquiries&amp;req=get&amp;id=$updated_id&quot; | mail -s &quot;New inquiry added through Form&quot; -aFrom:${sender_addr} ${notification_addr}
# ---end of inserted code --

if [ &quot;$session&quot; ];then
  rm -rf /var/www/tmp/$session
fi
</code></pre>
<p>Then you can get notification mail from inquiry APP when end user submit inquiry through Form. you can insert above code to any set action script of Form APPs or Scratch APPs.</p>
<h2 id="portal-design-recipe">Portal design recipe</h2>
<p>In this section, you can learn how you can change design of main page of your APP. let's create main page with no authentication and no databox for making the easiest example. of course any type of authentication can be selected and any databox can be attached.</p>
<pre><code>$ sudo /usr/local/small-shell/adm/gen -app
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 3
app_name: static_site
Type of Authentication (1.shared pass | 2.user key | 3.other | 4.none): 4
primary databox: none
</code></pre>
<h3 id="cook-main-page">Cook main page</h3>
<p>Let's start to cook main page. you can edit the page by 2 way. 1 is edit the page on Base APP {$APP_UI.md.def} web UI, then portal page could be generated. </p>
<h4 id="update-appuimddef-on-base-app">Update $app.UI.md.def on <a href="../app_shell_tour/#access-url-of-base-app">Base APP</a></h4>
<p><img alt="Screenshot" src="../img/test.UI.md.def.png" /></p>
<p>You can update description using both markdown and legach HTML. 
please check the markdown grammer <a href="https://21it.org/markdown.html">here</a> if needed. 
also you can update menu,logo and footer of portal on the same admin page. 
<img alt="Screenshot" src="../img/UI.md.detail.png" /></p>
<h3 id="htmlcss-grammar">HTML/CSS Grammar</h3>
<p>Another way of updating portal is just editting hml.def directly {$APP_main.html.def} </p>
<pre><code>sudo vi /var/www/descriptor/static_site_main.html.def
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please update under "main" class, then you can use light css framework</p>
</div>
<h4 id="update-left-header">Update left header</h4>
<p>You can modify links and logo to the left header, in this example link to Docs is added.</p>
<pre><code>! please upload image file to /var/www/html
</code></pre>
<pre><code>&lt;div class=&quot;left-header&quot;&gt;
  &lt;a href=&quot;https://github.com&quot;&gt;&lt;img src=&quot;../GitHub-Mark-32px.png&quot;&gt;&lt;/a&gt;
  &lt;a href=&quot;https://small-shell.org&quot;&gt;&lt;h2&gt;Docs&lt;/h2&gt;&lt;/a&gt;
&lt;/div&gt;
</code></pre>
<h4 id="implement-flex-table">Implement flex-table</h4>
<p>For implementing table, you must use some classes. table must be contain "flext-table" class. and header should have "flex-table-header" class.</p>
<pre><code>&lt;div class=&quot;flex-table&quot;&gt;
  &lt;ul&gt;
    &lt;li class=&quot;flex-table-header&quot;&gt;
      &lt;p&gt;column1&lt;/p&gt;
      &lt;p&gt;column2&lt;/p&gt;
      &lt;p&gt;column3&lt;/p&gt;
      &lt;p&gt;column4&lt;/p&gt;
    &lt;/li&gt;
    &lt;li&gt;
      &lt;p&gt;data1.column1&lt;/p&gt;
      &lt;p&gt;data1.column2&lt;/p&gt;
      &lt;p&gt;data1.column3&lt;/p&gt;
      &lt;p&gt;data1.column4&lt;/p&gt;
     &lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;
</code></pre>
<h5 id="add-internal-page-link-to-the-left-navi">Add internal page link to the left navi</h5>
<p>In this example, page will have 3 section including table section.</p>
<pre><code>&lt;div class=&quot;left-nav&quot;&gt;
 &lt;a href=&quot;#section1&quot;&gt;&lt;p&gt;section1&lt;/p&gt;&lt;/a&gt;
 &lt;a href=&quot;#section2&quot;&gt;&lt;p&gt;section2&lt;/p&gt;&lt;/a&gt;
 &lt;a href=&quot;#section3&gt;&lt;p&gt;section3p&gt;&lt;/a&gt;
&lt;/div&gt;
</code></pre>
<h5 id="use-button">Use button</h5>
<p>Button must have "button" class.</p>
<pre><code>&lt;button class=&quot;button&quot;&gt;Sample button&lt;/button&gt;
</code></pre>
<h5 id="use-image">Use image</h5>
<p>In this example, we would like to use GitHub logo for image. please upload logo to "/var/www/html" that's static site dir. then write down the path to the HTML page.</p>
<pre><code>&lt;a href=&quot;https://github.com&quot;&gt;&lt;img src=&quot;../GitHub-Mark-32px.png&quot;&gt;&lt;/a&gt;
</code></pre>
<h5 id="update-even-menu">Update even menu</h5>
<p>In this example, links in right header menu will be external links and mail addr.</p>
<pre><code>sudo vi /var/www/descriptor/common_parts/static_site_common_menu
</code></pre>
<pre><code>&lt;li&gt;&lt;a href=&quot;&quot;&gt;LINK 1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;&quot;&gt;LINK 2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;mailto:address&quot;&gt;MAIL&lt;/a&gt;&lt;/li&gt;
</code></pre>
<p>or If you don't need to use right header, just delete right header definition on $APP_main.html.def</p>
<pre><code>sudo vi /var/www/descriptor/static_site_main.html.def
</code></pre>
<h5 id="right-header-definition-on-mainhtmldef">right header definition on main.html.def</h5>
<pre><code>&lt;div class=&quot;right-header&quot;&gt;
&lt;button class=&quot;even-btn-menu&quot;&gt;=&lt;/button&gt;
 &lt;nav&gt;
 &lt;ul&gt;
 %%common_menu
 &lt;/ul&gt;
&lt;/nav&gt;
&lt;/div&gt;
</code></pre>
<h5 id="add-footer">Add footer</h5>
<p>Please use footer class for making footer.</p>
<pre><code>&lt;div class=&quot;footer&quot;&gt;
  &lt;p&gt;powered by small-shell.org&lt;/p&gt;
&lt;/div&gt;
</code></pre>
<h5 id="implement-form">Implement form</h5>
<p>If you want to implement form, it's recommended to use class="app-form" , please check following example.</p>
<pre><code>&lt;div class=&quot;app-form&quot;&gt;
  &lt;h1&gt;#new&lt;/h1&gt;
  &lt;form method=&quot;post&quot; action=&quot;&quot; onclick=&quot;document.charset='utf-8';&quot;&gt;
  &lt;ul&gt;
    &lt;li&gt;
      &lt;label&gt;name&lt;/label&gt;
      &lt;input type=&quot;text&quot; name=&quot;name&quot; value=&quot;&quot; required&gt;
    &lt;/li&gt;
    &lt;li&gt;
     &lt;label&gt;description&lt;/label&gt;
     &lt;input type=&quot;text&quot; name=&quot;description&quot; value=&quot;&quot; &gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;
</code></pre>
<h5 id="change-color">Change color</h5>
<p>You can change color by updating $APP.css.def</p>
<pre><code>sudo vi /var/www/descriptor/static_site.css.def
</code></pre>
<pre><code>#----------------classes---------------#
# Change header color
.flex-header

# Change right menu charactor
.right-header a

# Change right menu background and border color
.right-header nav 
.right-header nav.open-menu

# Change right header button (=)
.right-header .even-btn-menu

# Change button
.main button

# Change table header of main
.main .flex-table-header
#----------------------------------------#
</code></pre>
<h3 id="distribute-the-site-to-static-directory">Distribute the site to static directory</h3>
<p>You can export main page as static stie. then please copy the html to /var/www/html or other static directory.</p>
<pre><code>sudo /usr/local/small-shell/util/scripts/dist.sh $APP $EXPORT_DIR
</code></pre>
<h2 id="automate-ssl-cert-deployment">Automate SSL cert deployment</h2>
<p>In this cook, you can learn how to automate cert deployment by using Let's Encrypt as ssl certificate provider. please install certbot first.</p>
<h5 id="install-certbot">Install certbot</h5>
<pre><code>sudo snap install core
sudo snap refresh core
sudo snap install --classic certbot 
sudo ln -s /snap/bin/certbot /usr/bin/certbot
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A record of the domain must be set on DNS server beforehand. and it must be global IP that can be reachable from Let's encrypt server </p>
</div>
<h4 id="install-nginx-for-reverse-proxy">Install nginx for reverse proxy</h4>
<p>It's required to install nginx package with no configuration to use as reverse proxy later.</p>
<pre><code>sudo apt install nginx
</code></pre>
<h4 id="generate-base-app">Generate Base APP</h4>
<p>Base APP that will use small-shell WEB srv should be launched as http server not https so far. FQDN must be same as A record that you set beforehand on your DNS server. </p>
<pre><code>$ sudo /usr/local/small-shell/adm/gen -app
Type of APP (1.BASE | 2.FORM | 3.SCRATCH): 1
Type of server (1.small-shell WEB srv | 2.other WEB srv): 1
protocol (http | https): http
WEB Server FQDN or IP addr (e.g. 192.168.10.1): $FQDN
</code></pre>
<h4 id="import-job-and-deploy-ssl-certificate">Import job and deploy ssl certificate</h4>
<p>Once you install certbot and launched Base APP, please kick configure.sh and deploy.sh. then dialog will be started. please answer your mail address that is reqiured to publish certificate by Let's Encrypt</p>
<pre><code>cd $HOME
git clone https://github.com/naruoken/small-shell-apps
cd ./small-shell-apps/ssl_auto
chmod 755 *.sh
sudo ./configure.sh
sudo ./deploy.sh
</code></pre>
<h4 id="dialog">dialog</h4>
<p>Following is exmaple of dialog.</p>
<pre><code>small-shell root (/usr/local/small-shell):
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Enter email address (used for urgent renewal and security notices)
 (Enter 'c' to cancel): ****@***.com

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please read the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.3-September-21-2022.pdf. You must
agree in order to register with the ACME server. Do you agree?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o:Y

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing, once your first certificate is successfully issued, to
share your email address with the Electronic Frontier Foundation, a founding
partner of the Let's Encrypt project and the non-profit organization that
develops Certbot? We'd like to send you email about our work encrypting the web,
EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: Y
Account registered.
Requesting a certificate for ***.com
</code></pre>
<p>If everything is no problem, https will be enabled automatically by deploy.sh. by the way configure.sh will set up reverse proxy using nginx package.</p>
<h4 id="add-sudoer">Add Sudoer</h4>
<p>You must add following setting on sudoers to execute SSL refresh job regularly.</p>
<pre><code>$ sudo visudo
# add following to bottom of the file, if there is no small-shell entry
small-shell   ALL=(ALL:ALL)    NOPASSWD: /usr/local/small-shell/adm/*, /usr/local/small-shell/util/scripts/*
</code></pre>
<h4 id="check-job">Check job</h4>
<p>Once deploy is completed, ssl job that will refresh ssl cert will be on e-cron.</p>
<pre><code>$ sudo -u small-shell /usr/local/small-shell/bin/e-cron ls | grep ssl
ssl_auto.enabled
</code></pre>
<p>If it's enabled SSL implementation is completed.</p>
<h2 id="make-replica-for-load-balancing">Make replica for load balancing</h2>
<p>Small-Shell WEB APPs and databoxes can be synced to replica hosts and it can be put under load balancer. 
load balander must be setup beforehand on cloud env or physical env.   </p>
<h4 id="requirement-of-load-balancing">Requirement of load balancing</h4>
<p>Please be aware that load balancer must ensure session persistence.
And load balancing logic must be just TCP port proxy (not terminate SSL/TLS) because write request will go to real server FQDN of master server directly. it's recommended to use wild card certificate or automated certificate. implement procedure of automated certificate will be explained later step.</p>
<pre><code> Read Req  &gt; Load Balancer # ensure session persistence
             TCP port forwarding
             | - Master host #response on 80,443 port
             |-  Replica hosts #response on 80,443 port

 Write Req &gt; Load Balancer # ensure session persistence
             TCP port forwarding
             | - Master host #response on 80,443 port
             |-  Replica hosts &gt; it will be redirected to real server FQDN of master host
</code></pre>
<h4 id="setup-environment">Setup environment</h4>
<p>Before build replica, you need to setup Base APP using small-shell WEB srv on both master and replica server. when input server FQDN, please input real server FQDN (I mean not load balancing address) and protocol should be http so far not https.</p>
<pre><code>@master
sudo apt install lsyncd
sudo mkdir /etc/lsyncd
sudo apt install nginx
sudo /usr/local/small-shell/adm/gen -app #Base APP (required), Scratch APP (optional)

@replica
sudo apt install nginx
sudo /usr/local/small-shell/adm/gen -app #Base APP (required)
</code></pre>
<h4 id="get-key">Get key</h4>
<p>Then let's get key to communicate between master and replica. "show.pub" option will show the key. please copy the key. it must be paste next STEP.
When you execute mkrep.sh with the option first time, PATH of the key will be confirmed. it must be /home/small-shell/.ssh/id_rsa.</p>
<pre><code>@master @replica 
sudo /usr/local/small-shell/util/scripts/mkrep.sh show.pub
Generating public/private rsa key pair.
Enter file in which to save the key (/home/small-shell/.ssh/id_rsa): &lt;Enter&gt;
</code></pre>
<h4 id="build-replication">Build Replication</h4>
<p>Once key is ready, replication can be built by "reg" option. you must answer the dialog and paste public key that you get beorehand.</p>
<pre><code>@master 
sudo /usr/local/small-shell/util/scripts/mkrep.sh reg.replica
&gt; dialog will be started

@replica
sudo /usr/local/small-shell/util/scripts/mkrep.sh reg.master
&gt; dialog will be started
</code></pre>
<h4 id="automated-deployment-of-ssl-cert-for-load-balancing">Automated deployment of SSL cert for load balancing</h4>
<p>To enable https, it's recommended to use ssl auto script as following step. please check details of automation setting on <a href="./#automate-ssl-cert-deployment">Deploy auto SSL cetificate</a>.</p>
<pre><code>@master 
cd $HOME
git clone https://github.com/naruoken/small-shell-apps
cd ./small-shell-apps/ssl_auto
chmod 755 *.sh
sudo ./configure.sh
sudo ./deploy.sh

@replica
cd $HOME
git clone https://github.com/naruoken/small-shell-apps
cd ./small-shell-apps/ssl_auto
chmod 755 *.sh
sudo ./configure.sh
sudo ./deploy.sh
</code></pre>
<h4 id="create-users-for-apps">Create users for APPs</h4>
<p>Once replication and SSL is ready, please create users for APPs.</p>
<pre><code>sudo /usr/local/small-shell/adm/ops add.usr:$user #Base APP 
sudo /usr/local/small-shell/adm/ops add.usr:$user app:$app #Scratch APP
</code></pre>
<h4 id="add-new-app-or-rebuild-replication">Add new APP or rebuild replication.</h4>
<p>If you will add new APP after starting replication or rebuild replication for adding new host, please remove all replication setting with purge option.</p>
<pre><code>@master @replica_hosts
sudo /usr/local/small-shell/util/scripts/mkrep.sh purge
sudo /usr/local/small-shell/util/scripts/mkrep.sh show.pub

@master 
sudo /usr/local/small-shell/adm/gen -app #create new APP
sudo /usr/local/small-shell/util/scripts/mkrep.sh reg.replica

@replica_hosts
sudo /usr/local/small-shell/util/scripts/mkrep.sh reg.master
</code></pre>
<h2 id="backup-restore-example">Backup &amp; Restore example</h2>
<p>In this cook, 1 production node will send backup to backuo node through e-cron HUB API</p>
<pre><code>| prod node | -- | backup node #e-cron HUB|
</code></pre>
<h4 id="usage-of-bkup-and-rstr">Usage of bkup and rstr</h4>
<pre><code>sudo /usr/local/small-shell/adm/bkup $dir
sudo /usr/local/small-shell/adm/rstr $dir
</code></pre>
<h4 id="operation-at-backup-node">Operation at backup node</h4>
<p>It's required to Launch Base APP and check e-cron URL and key</p>
<pre><code>@backup_node
sudo /usr/local/small-shell/adm/gen -app 
cat /usr/local/small-shell/web/base | grep hubapi
cat /usr/local/small-shell/web/base | grep api_authkey
</code></pre>
<h4 id="operation-at-production-node">Operation at production node</h4>
<p>Once e-cron HUB is ready,define backup &amp; sync job on pdocution node. bkup command will backup every data of small-shell including user info, databox{data,log}, APP, Job... and sudo privilede is required for executing bkup command. please add sudoers beforehand. </p>
<pre><code>@production_node
$ sudo visudo
# add folowing line, if there is no small-shell entry
small-shell   ALL=(ALL:ALL)    NOPASSWD: /usr/local/small-shell/adm/*, /usr/local/small-shell/util/scripts/*

# define backup job
$ sudo /usr/local/small-shell/adm/gen -job
Job Name: backup
Type of job (1.job automation | 2.file exchange) : 1
--Define schedule--
Month [ any | 1-12 ]: any
Date  [ any | 1-31 ]: any
Hour  [ any | 0-23 ]: 0 
Min   [ any | 0-59 ]: 1
Week  [ any | mon - sun ]: any
Exec command or batch script: sudo /usr/local/small-shell/adm/bkup /var/tmp

# define push job, please confirm URL and authkey at backup node beforehand
$ sudo /usr/local/small-shell/adm/gen -job
Type of job (1.job automation | 2.file exchange) : 2
--Define schedule--
Month [ any | 1-12 ]: any
Date  [ any | 1-31 ]: any
Hour  [ any | 0-23 ]: 1
Min   [ any | 0-59 ]: 0
Week  [ any | mon - sun ]: any
Type of file exchange (push | get): push
local directory: /var/tmp
file_name: *tar.xz
HUB API URL: $hubapi
API authkey: $api_authkey
</code></pre>
<h4 id="backup-file">Backup file</h4>
<p>If bkup/push job works fine, there is backup files on que/file directry on backup node</p>
<pre><code>@backup_node
ls /usr/local/small-shell/util/e-cron/que/file
$server.core.tar.xz  $server.ssh.tar.xz  $server.www.tar.xz
</code></pre>
<h4 id="restore">Restore</h4>
<p>For restoring backup file, please install small-shell from git and launch Base APP first. and rstr command option must be directory where backup files are copied from backup node.</p>
<pre><code>@restore_node
sudo /usr/local/small-shell/adm/rstr $dir
</code></pre>
<h2 id="dictionary-create-lang-pack">Dictionary (create lang pack)</h2>
<p>You can create language pack for WEB APP using following template.</p>
<pre><code>cd $HOME
git clone https://github.com/naruoken/small-shell-apps
cd small-shell-apps/dictionary/template
</code></pre>
<h4 id="usage-of-keywords-file">Usage of keywords file</h4>
<p>"keywords" file will be used for translating words to your language. please update them. by the way {%%%%%%} is a separator that is used instead of conma.</p>
<pre><code># at small-shell-apps/dictionary/template
vi keywords 
-----
##########################################################
# usage: original_word{%%%%%%}translated_word
##########################################################
ScratchAPP:APP Portal{%%%%%%}
ScratchAPP:Table{%%%%%%}
ScratchAPP:Log Out{%%%%%%}
Your Key is successfully generated.{%%%%%%}
----
</code></pre>
<h4 id="deployment">Deployment</h4>
<p>Once keywords file is updated, deploy it by using deploy.sh</p>
<pre><code># at small-shell-apps/dictionary/template
./deploy.sh
</code></pre>
<h2 id="log-analyzer">Log analyzer</h2>
<p>You can import job for analyzing log of small-shell web from github.</p>
<h6 id="link-to-code-is-here">Link to code is  <a href="https://github.com/naruoken/small-shell-apps">here</a></h6>
<pre><code>cd $HOME
git clone https://github.com/naruoken/small-shell-apps
cd small-shell-apps/ssw_log_analyzer

# Deploy job
sudo ./deploy.sh
</code></pre>
<h4 id="confirm-imported-job">confirm imported job</h4>
<p>If deploy.sh executed without any error, 1 databox {web_analyer} and 3 job will be imported.</p>
<h6 id="log-analyzer_1">log analyzer</h6>
<pre><code>sudo -u small-shell /usr/local/small-shell/bin/e-cron cat.ssw_log_analyzer
</code></pre>
<pre><code> &gt; JOB: ssw_log_analyzer
def:/usr/local/small-shell/util/e-cron/def/ssw_log_analyzer.def
-------------SCHEDULE----------------
min: 1
hour: 0
date: any
month: any
week: any
-------------DEFINITION----------------
exec_command=&quot;/usr/local/small-shell/util/scripts/ssw_log_analyzer.sh&quot;
input_message=&quot;&quot;
output_message=&quot;analyzer.done&quot;
hubapi=&quot;&quot;
api_authkey=&quot;&quot;
</code></pre>
<h6 id="attack-statistics">attack statistics</h6>
<pre><code>sudo -u small-shell /usr/local/small-shell/bin/e-cron cat.attack_statistics
</code></pre>
<pre><code> &gt; JOB: pv_statistics
def:/usr/local/small-shell/util/e-cron/def/attack_statistics.def
-------------SCHEDULE----------------
min: 0
hour: 1
date: any
month: any
week: any
-------------DEFINITION----------------
exec_command=&quot;/usr/local/small-shell/util/scripts/sumup.sh type:line sumup_key:attack frequency:daily title:attack set_time:\&quot;`date +%Y-%m-%d --date '1 day ago'`\&quot; global_filter:\&quot;`date +%Y-%m-%d --date '1 day ago'`\&quot; databox:web_analyzer&quot;
input_message=&quot;analyzer.done&quot;
output_message=&quot;attack.done&quot;
hubapi=&quot;&quot;
api_authkey=&quot;&quot;
</code></pre>
<h6 id="uniq-access">uniq access</h6>
<pre><code>sudo -u small-shell /usr/local/small-shell/bin/e-cron cat.uniq_statistics
</code></pre>
<pre><code> &gt; JOB: uniq_statistics
def:/usr/local/small-shell/util/e-cron/def/uniq_statistics.def
-------------SCHEDULE----------------
min: 10
hour: 1
date: any
month: any
week: any
-------------DEFINITION----------------
exec_command=&quot;/usr/local/small-shell/util/scripts/sumup.sh type:line sumup_key:uniq_access frequency:daily title:pv set_time:\&quot;`date +%Y-%m-%d --date '1 day ago'`\&quot; global_filter:\&quot;`date +%Y-%m-%d --date '1 day ago'`\&quot; databox:web_analyzer&quot;
input_message=&quot;pv.done&quot;
output_message=&quot;&quot;
hubapi=&quot;&quot;
api_authkey=&quot;&quot;
</code></pre>
<h4 id="confirm-result">Confirm result</h4>
<p>Job will push the result to the databox named as web_annalyzer. Log analytics target is srvdump.log.1 it means 1 day ago log. you can check the graph on console. using #stats command.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
